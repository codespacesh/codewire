services:
  relay:
    build: .
    command: ["relay", "--base-url", "https://localhost", "--listen", "0.0.0.0:8080", "--data-dir", "/data/relay", "--auth-mode", "none"]
    ports:
      - "8080:8080"
      - "41820:41820/udp"
    volumes:
      - relay_data:/data
    environment:
      - TERM=xterm-256color

  caddy:
    image: caddy:2-alpine
    ports:
      - "9443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - relay
      - codewire

  codewire:
    build: .
    ports:
      - "9100:9100"
    environment:
      - CODEWIRE_NODE_NAME=docker-test
      - CODEWIRE_LISTEN=0.0.0.0:9100
      - CODEWIRE_RELAY_URL=http://relay:8080
      - CODEWIRE_TOKEN=test-token-for-e2e
      - CODEWIRE_EXTERNAL_URL=wss://localhost:9443/ws
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TERM=xterm-256color
    depends_on:
      - relay

volumes:
  relay_data:
  caddy_data:
  caddy_config:
