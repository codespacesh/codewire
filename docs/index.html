<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Codewire — Persistent process server for AI coding agents</title>
<meta name="description" content="Like tmux, but purpose-built for long-running LLM processes. Persistent sessions, SSH relay gateway, event-driven orchestration, MCP integration.">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:#0d0d0d;
  --bg-alt:#161616;
  --bg-code:#1a1a1a;
  --fg:#c8c8c8;
  --fg-dim:#707070;
  --fg-bright:#e8e8e8;
  --accent:#7eb8da;
  --accent-dim:#4a7a96;
  --border:#252525;
  --radius:8px;
  --font-sans:ui-sans-serif,system-ui,-apple-system,sans-serif;
  --font-mono:ui-monospace,"SF Mono","Cascadia Code","Fira Code",Menlo,Consolas,monospace;
  --max-w:780px;
  --header-h:52px;
}

[data-theme="light"]{
  --bg:#f8f8f8;
  --bg-alt:#ffffff;
  --bg-code:#eef1f5;
  --fg:#2a2a2a;
  --fg-dim:#888;
  --fg-bright:#111;
  --accent:#2b6e96;
  --accent-dim:#1a4d6b;
  --border:#ddd;
}

html{scroll-behavior:smooth;scroll-padding-top:calc(var(--header-h) + 24px)}
body{font-family:var(--font-sans);background:var(--bg);color:var(--fg);line-height:1.65;font-size:15px;-webkit-font-smoothing:antialiased}

/* ── Header ── */
header{
  position:sticky;top:0;z-index:100;
  height:var(--header-h);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;
  background:var(--bg);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
}
header .logo{font-family:var(--font-mono);font-weight:700;font-size:16px;color:var(--fg-bright);text-decoration:none;letter-spacing:-.5px}
header .logo span{color:var(--accent)}
header nav{display:flex;align-items:center;gap:20px}
header nav a{color:var(--fg-dim);text-decoration:none;font-size:13px;transition:color .15s}
header nav a:hover{color:var(--fg-bright)}
.theme-toggle{
  background:none;border:1px solid var(--border);border-radius:var(--radius);
  color:var(--fg-dim);cursor:pointer;padding:5px 8px;font-size:14px;
  transition:border-color .15s,color .15s;line-height:1;
}
.theme-toggle:hover{color:var(--fg-bright);border-color:var(--fg-dim)}
.gh-link{color:var(--fg-dim);display:flex;align-items:center;transition:color .15s;margin-right:4px}
.gh-link:hover{color:var(--fg-bright)}

.nav-links{display:flex;gap:20px}
@media(max-width:680px){.nav-links{display:none}}

/* ── Layout ── */
main{max-width:var(--max-w);margin:0 auto;padding:0 24px 80px}

section{padding:56px 0 0}
section+section{border-top:1px solid var(--border);margin-top:56px}

h1{font-size:32px;font-weight:700;color:var(--fg-bright);letter-spacing:-.5px;line-height:1.2}
h2{font-size:22px;font-weight:700;color:var(--fg-bright);margin-bottom:16px;letter-spacing:-.3px}
h3{font-size:16px;font-weight:600;color:var(--fg-bright);margin:28px 0 10px}
h4{font-size:14px;font-weight:600;color:var(--accent);margin:20px 0 8px;font-family:var(--font-mono)}

p{margin:10px 0;max-width:62ch}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

ul,ol{margin:8px 0 8px 20px}
li{margin:4px 0}

/* ── Code ── */
code{
  font-family:var(--font-mono);font-size:13px;
  background:var(--bg-code);padding:2px 6px;border-radius:3px;
}
pre{
  background:var(--bg-code);border:1px solid var(--border);border-radius:var(--radius);
  padding:16px 18px;overflow-x:auto;font-family:var(--font-mono);font-size:13px;
  line-height:1.55;color:var(--fg);position:relative;margin:12px 0;
}
pre code{background:none;padding:0;border-radius:0}

/* Syntax-ish hints */
.kw{color:#c586c0}
.str{color:#ce9178}
.cmt{color:#6a9955}
.fn{color:#dcdcaa}
.num{color:#b5cea8}
.flag{color:#9cdcfe}
.cmd{color:var(--accent)}

/* ── Copy button ── */
.code-block{position:relative}
.copy-btn{
  position:absolute;top:8px;right:8px;
  background:var(--bg-alt);border:1px solid var(--border);border-radius:4px;
  color:var(--fg-dim);cursor:pointer;padding:4px 8px;font-size:11px;
  font-family:var(--font-mono);transition:all .15s;opacity:0;
}
.code-block:hover .copy-btn{opacity:1}
.copy-btn:hover{color:var(--fg-bright);border-color:var(--fg-dim)}
.copy-btn.copied{color:var(--accent);border-color:var(--accent)}

/* ── Hero ── */
.hero{text-align:center;padding:96px 0 48px;border:none}
.hero+section{margin-top:0}
.hero h1{font-size:clamp(36px,6vw,56px);margin-bottom:16px;letter-spacing:-0.02em}
.hero .tagline{color:var(--accent);font-family:var(--font-mono);font-size:14px;margin-bottom:16px;letter-spacing:.5px}
.hero .desc{color:var(--fg-dim);font-size:16px;max-width:52ch;margin:0 auto 32px;line-height:1.6}
.hero .install-cmd{
  display:inline-flex;align-items:center;gap:12px;
  background:var(--bg-code);border:1px solid var(--border);border-radius:var(--radius);
  padding:12px 18px;font-family:var(--font-mono);font-size:14px;
}
.hero .install-cmd .prompt{color:var(--fg-dim);user-select:none}
.hero .install-cmd code{background:none;padding:0;font-size:14px;color:var(--fg-bright)}
.hero .install-cmd .copy-btn{position:static;opacity:1}

/* ── Tables ── */
table{width:100%;border-collapse:collapse;margin:12px 0;font-size:13px}
th{text-align:left;padding:8px 12px;border-bottom:2px solid var(--border);color:var(--fg-dim);font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
td{padding:8px 12px;border-bottom:1px solid var(--border);vertical-align:top}
td code{font-size:12px}

/* ── Diagrams ── */
.diagram{
  background:var(--bg-code);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px 24px;overflow-x:auto;margin:16px 0;
  font-family:var(--font-mono);font-size:12px;line-height:1.4;
  color:var(--fg);white-space:pre;
}
.diagram .label{color:var(--accent)}
.diagram .dim{color:var(--fg-dim)}
.diagram .hl{color:var(--fg-bright);font-weight:600}

/* ── Quick Start Steps ── */
.steps{counter-reset:step}
.step{
  counter-increment:step;
  padding:16px 0 16px 44px;position:relative;
  border-left:1px solid var(--border);margin-left:14px;
}
.step:last-child{border-left-color:transparent}
.step::before{
  content:counter(step);position:absolute;left:-14px;top:14px;
  width:28px;height:28px;border-radius:50%;
  background:var(--bg-alt);border:2px solid var(--accent);
  color:var(--accent);font-size:13px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  font-family:var(--font-mono);
}
.step h3{margin-top:0;font-size:15px}

/* ── Command cards ── */
.cmd-group{margin:24px 0}
.cmd-entry{margin:16px 0;padding:12px 0;border-bottom:1px solid var(--border)}
.cmd-entry:last-child{border-bottom:none}
.cmd-sig{font-family:var(--font-mono);font-size:14px;color:var(--fg-bright);margin-bottom:6px}
.cmd-sig .optional{color:var(--fg-dim)}
.cmd-desc{color:var(--fg-dim);font-size:13px;margin-bottom:8px}

/* ── Config keys ── */
.config-key{
  font-family:var(--font-mono);font-size:13px;color:var(--accent);
  display:inline-block;min-width:200px;
}
.config-val{color:var(--fg-dim);font-size:13px}

/* ── Badge row ── */
.badges{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
.badge{
  font-family:var(--font-mono);font-size:11px;
  padding:3px 8px;border-radius:3px;
  background:var(--bg-code);border:1px solid var(--border);
  color:var(--fg-dim);
}

/* ── Terminal Demo ── */
.term-demo{
  max-width:640px;margin:32px auto 0;border-radius:var(--radius);
  border:1px solid var(--border);overflow:hidden;text-align:left;
  background:var(--bg-code);position:relative;
}
.term-chrome{
  display:flex;align-items:center;gap:8px;
  padding:10px 14px;background:var(--bg-alt);
  border-bottom:1px solid var(--border);
}
.term-dot{width:10px;height:10px;border-radius:50%}
.term-dot.red{background:#ff5f57}
.term-dot.yellow{background:#ffbd2e}
.term-dot.green{background:#28c840}
.term-title{
  flex:1;text-align:center;
  font-family:var(--font-mono);font-size:11px;color:var(--fg-dim);
  margin-right:38px;
}
.term-body{
  padding:14px 16px;min-height:260px;
  font-family:var(--font-mono);font-size:13px;line-height:1.55;
  position:relative;overflow:hidden;
}
.term-lines{color:var(--fg)}
.term-line{white-space:pre-wrap;word-break:break-all}
.term-line .prompt-mark{color:var(--fg-dim);user-select:none}
.term-line .output{color:var(--fg-dim)}
.term-line .table-header{color:var(--fg-dim)}
.term-line .table-row{color:var(--fg)}
.term-line .accent{color:var(--accent)}
.term-input-line{display:flex;white-space:pre}
.term-prompt{color:var(--fg-dim);user-select:none}
.term-typed{color:var(--fg-bright)}
.term-cursor{
  display:inline-block;width:7px;height:15px;
  background:var(--fg-bright);vertical-align:text-bottom;
  animation:blink 1s step-end infinite;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.term-demo.fade-out .term-body{animation:fadeOut .6s ease-out forwards}
@keyframes fadeOut{to{opacity:0}}

/* ── Live Demo Widget ── */
.try-live-btn{
  display:inline-flex;align-items:center;gap:6px;
  position:absolute;top:8px;right:8px;z-index:10;
  padding:5px 12px;border-radius:4px;
  background:var(--accent);color:#0d0d0d;
  border:none;cursor:pointer;
  font-family:var(--font-mono);font-size:11px;font-weight:600;
  transition:opacity .15s;
}
.try-live-btn:hover{opacity:0.85}
.try-live-btn .pulse{
  width:6px;height:6px;border-radius:50%;
  background:#28c840;
  animation:pulse-dot 2s ease-in-out infinite;
}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.4}}
.live-term-container{min-height:260px;position:relative}
.live-term-container .xterm{height:100%}
.live-toolbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:6px 14px;background:var(--bg-alt);
  border-top:1px solid var(--border);
  font-family:var(--font-mono);font-size:11px;
}
.live-timer{color:var(--fg-dim)}
.live-timer.warning{color:#e5a83e}
.live-timer.critical{color:#e55}
.live-expand{
  color:var(--accent);text-decoration:none;font-size:11px;
  font-family:var(--font-mono);
}
.live-expand:hover{text-decoration:underline}
.live-close-btn{
  background:none;border:none;color:var(--fg-dim);
  cursor:pointer;font-family:var(--font-mono);font-size:11px;
}
.live-close-btn:hover{color:var(--fg-bright)}

/* ── Responsive ── */
@media(max-width:600px){
  header{padding:0 16px}
  main{padding:0 16px 60px}
  .hero{padding:48px 0 24px}
  pre{padding:12px 14px;font-size:12px}
  .diagram{padding:14px 16px;font-size:11px}
  table{font-size:12px}
  th,td{padding:6px 8px}
  .term-body{min-height:220px;font-size:12px;padding:10px 12px}
  .term-demo{margin:24px auto 0}
}
</style>
</head>
<body>

<!-- ════════════════════════ Header ════════════════════════ -->
<header>
  <a href="#" class="logo">code<span>wire</span></a>
  <nav>
    <div class="nav-links">
      <a href="#quickstart">Quick Start</a>
      <a href="#commands">Commands</a>
      <a href="#messaging">Messaging</a>
      <a href="#orchestration">Orchestration</a>
      <a href="#relay">Relay</a>
      <a href="#mcp">MCP</a>
    </div>
    <a href="https://github.com/codewiresh/codewire" class="gh-link" aria-label="GitHub" target="_blank" rel="noopener">
      <svg viewBox="0 0 16 16" width="18" height="18" fill="currentColor" aria-hidden="true">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
      </svg>
    </a>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
      <span id="theme-icon">&#9790;</span>
    </button>
  </nav>
</header>

<main>

<!-- ════════════════════════ Hero ════════════════════════ -->
<section class="hero" id="top">
  <div class="tagline">Persistent process server for AI coding agents</div>
  <h1>Codewire</h1>
  <p class="desc">
    Like tmux, but purpose-built for long-running LLM processes.
    Native terminal scrolling, copy/paste, and no weird key chords.
    Tags, subscriptions, wait &mdash; LLM orchestration primitives built in.
  </p>
  <div class="install-cmd code-block">
    <span class="prompt">$</span>
    <code>brew install codewiresh/codewire/codewire</code>
    <button class="copy-btn" onclick="copyText('brew install codewiresh/codewire/codewire',this)">copy</button>
  </div>

  <div class="term-demo" id="term-demo">
    <a href="/demo" class="try-live-btn" id="try-live-btn" target="_blank" rel="noopener">
      <span class="pulse"></span> Try it live
    </a>
    <div class="term-chrome">
      <span class="term-dot red"></span>
      <span class="term-dot yellow"></span>
      <span class="term-dot green"></span>
      <span class="term-title" id="term-title">codewire demo</span>
    </div>
    <div class="term-body" id="term-animated">
      <div class="term-lines"></div>
      <div class="term-input-line">
        <span class="term-prompt">$ </span>
        <span class="term-typed"></span>
        <span class="term-cursor"></span>
      </div>
    </div>
    <div class="live-term-container hidden" id="live-term-container"></div>
    <div class="live-toolbar hidden" id="live-toolbar">
      <span class="live-timer" id="live-status">Connecting...</span>
      <a href="/demo" class="live-expand" id="live-expand">Open full terminal</a>
      <button class="live-close-btn" onclick="window.cwDemo.closeLive()">Close</button>
    </div>
  </div>
</section>

<!-- ════════════════════════ Quick Start ════════════════════════ -->
<section id="quickstart">
  <h2>Quick Start</h2>
  <div class="steps">
    <div class="step">
      <h3>Launch a session</h3>
      <p>Start a persistent process in a PTY. It runs in the background even if you disconnect.</p>
      <div class="code-block"><pre><code><span class="cmd">cw launch</span> worker <span class="flag">--dir</span> ~/project <span class="flag">--tag</span> build <span class="flag">--</span> claude <span class="flag">-p</span> <span class="str">"refactor the auth module"</span></code></pre><button class="copy-btn" onclick="copyText('cw launch worker --dir ~/project --tag build -- claude -p &quot;refactor the auth module&quot;',this)">copy</button></div>
    </div>
    <div class="step">
      <h3>Attach to it</h3>
      <p>Take over your terminal and interact with the running process. Detach with <code>Ctrl+B d</code>.</p>
      <div class="code-block"><pre><code><span class="cmd">cw attach</span> <span class="num">1</span></code></pre><button class="copy-btn" onclick="copyText('cw attach 1',this)">copy</button></div>
    </div>
    <div class="step">
      <h3>List sessions</h3>
      <p>See all running and completed sessions with their status, tags, and age.</p>
      <div class="code-block"><pre><code><span class="cmd">cw list</span>

 <span class="dim">ID  NAME      STATUS     TAGS           AGE     COMMAND</span>
  1  planner   running    worker,build   2m ago  claude -p "refactor the auth module"
  2  coder     running    worker         45s     claude -p "implement changes"</code></pre><button class="copy-btn" onclick="copyText('cw list',this)">copy</button></div>
    </div>
    <div class="step">
      <h3>Wait or kill</h3>
      <p>Block until sessions complete, or kill by ID or tag.</p>
      <div class="code-block"><pre><code><span class="cmd">cw wait</span> <span class="flag">--tag</span> worker <span class="flag">--condition</span> all   <span class="cmt"># block until all workers finish</span>
<span class="cmd">cw kill</span> <span class="flag">--tag</span> worker                    <span class="cmt"># kill all workers</span>
<span class="cmd">cw kill</span> <span class="num">1</span>                                <span class="cmt"># kill session 1</span></code></pre><button class="copy-btn" onclick="copyText('cw wait --tag worker --condition all',this)">copy</button></div>
    </div>
  </div>
</section>

<!-- ════════════════════════ Commands ════════════════════════ -->
<section id="commands">
  <h2>Commands</h2>
  <p>Global flags: <code>--server &lt;name|url&gt;</code> and <code>--token &lt;token&gt;</code> for remote connections. All commands accept an optional node prefix for remote access (e.g. <code>cw list dev-1</code>).</p>

  <h3>Sessions</h3>
  <div class="cmd-group">
    <div class="cmd-entry">
      <div class="cmd-sig">cw launch <span class="optional">[name]</span> <span class="optional">[--dir &lt;dir&gt;] [--tag &lt;tag&gt;...]</span> -- &lt;command&gt; <span class="optional">[args...]</span></div>
      <div class="cmd-desc">Start a new session in a persistent PTY. Optional positional name before <code>--</code> gives a stable identifier for messaging. Tags enable filtering and orchestration.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw attach <span class="optional">[&lt;id&gt;] [--no-history]</span></div>
      <div class="cmd-desc">Connect to a running session. Omit ID to auto-select the oldest unattached session. Detach with <code>Ctrl+B d</code>.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw list <span class="optional">[node] [--json]</span></div>
      <div class="cmd-desc">Show all sessions with status, tags, age, and prompt. Enriched metadata includes exit code, duration, output stats.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw kill &lt;id&gt; <span class="optional">[--all] [--tag &lt;tag&gt;]</span></div>
      <div class="cmd-desc">Terminate a session. Use <code>--all</code> to kill everything, or <code>--tag</code> to kill by tag.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw logs &lt;id&gt; <span class="optional">[--follow] [--tail &lt;N&gt;]</span></div>
      <div class="cmd-desc">View captured output without attaching. <code>-f</code> streams new output.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw send &lt;id&gt; <span class="optional">[input] [--stdin] [--file &lt;path&gt;] [--no-newline]</span></div>
      <div class="cmd-desc">Send input to a session without attaching. Read from stdin, file, or argument.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw watch &lt;id&gt; <span class="optional">[--tail &lt;N&gt;] [--no-history] [--timeout &lt;s&gt;]</span></div>
      <div class="cmd-desc">Monitor a session in real-time without attaching. Read-only observation.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw status &lt;id&gt; <span class="optional">[--json]</span></div>
      <div class="cmd-desc">Get detailed session info including exit code, duration, tags, PID, and output stats.</div>
    </div>
  </div>

  <h3>Orchestration</h3>
  <div class="cmd-group">
    <div class="cmd-entry">
      <div class="cmd-sig">cw subscribe <span class="optional">[node] [--tag &lt;tag&gt;] [--event &lt;type&gt;] [--session &lt;id&gt;]</span></div>
      <div class="cmd-desc">Subscribe to real-time session events. Events stream until disconnect.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw wait <span class="optional">[node:]&lt;id&gt; [--tag &lt;tag&gt;] [--condition all|any] [--timeout &lt;s&gt;]</span></div>
      <div class="cmd-desc">Block until sessions complete. Wait by ID, tag, or both.</div>
    </div>
  </div>

  <h3 id="messaging">Messaging</h3>
  <div class="cmd-group">
    <div class="cmd-entry">
      <div class="cmd-sig">cw msg &lt;target&gt; &lt;body&gt; <span class="optional">[-f &lt;session&gt;]</span></div>
      <div class="cmd-desc">Send a direct message to a session. Target can be a session ID or name.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw inbox &lt;session&gt; <span class="optional">[-t &lt;N&gt;]</span></div>
      <div class="cmd-desc">Read messages from a session's inbox. Shows direct messages and pending requests.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw request &lt;target&gt; &lt;body&gt; <span class="optional">[-f &lt;session&gt;] [--timeout &lt;s&gt;]</span></div>
      <div class="cmd-desc">Send a request and block until a reply arrives. Synchronous coordination between agents.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw reply &lt;request-id&gt; &lt;body&gt; <span class="optional">[-f &lt;session&gt;]</span></div>
      <div class="cmd-desc">Reply to a pending request. Request ID comes from <code>cw inbox</code> or <code>message.request</code> events.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw listen <span class="optional">[--session &lt;session&gt;]</span></div>
      <div class="cmd-desc">Stream all message traffic in real-time. Shows messages, requests, and replies as they happen.</div>
    </div>
  </div>

  <h3>Remote</h3>
  <div class="cmd-group">
    <div class="cmd-entry">
      <div class="cmd-sig">cw nodes</div>
      <div class="cmd-desc">List all nodes registered with the relay.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw setup <span class="optional">[relay-url]</span></div>
      <div class="cmd-desc">Authorize this node with a relay using the device authorization flow.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw relay <span class="optional">[--base-url &lt;url&gt;] [--data-dir &lt;dir&gt;] [--auth-mode &lt;mode&gt;]</span></div>
      <div class="cmd-desc">Run a relay server (SSH gateway, node discovery, shared KV).</div>
    </div>
  </div>

  <h3>Shared KV</h3>
  <div class="cmd-group">
    <div class="cmd-entry">
      <div class="cmd-sig">cw kv set <span class="optional">[--ns &lt;namespace&gt;] [--ttl &lt;duration&gt;]</span> &lt;key&gt; &lt;value&gt;</div>
      <div class="cmd-desc">Set a key-value pair on the relay's shared store.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw kv get <span class="optional">[--ns &lt;namespace&gt;]</span> &lt;key&gt;</div>
      <div class="cmd-desc">Get a value by key.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw kv list <span class="optional">[--ns &lt;namespace&gt;]</span> <span class="optional">[prefix]</span></div>
      <div class="cmd-desc">List keys by prefix.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw kv delete <span class="optional">[--ns &lt;namespace&gt;]</span> &lt;key&gt;</div>
      <div class="cmd-desc">Delete a key.</div>
    </div>
  </div>

  <h3>Node &amp; Servers</h3>
  <div class="cmd-group">
    <div class="cmd-entry">
      <div class="cmd-sig">cw node</div>
      <div class="cmd-desc">Start the node process. Usually auto-started on first CLI invocation.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw stop</div>
      <div class="cmd-desc">Stop the running node gracefully.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw server add &lt;name&gt; &lt;url&gt; <span class="optional">[--token &lt;token&gt;]</span></div>
      <div class="cmd-desc">Save a remote server or relay connection. Token optional for relay URLs.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw server remove &lt;name&gt;</div>
      <div class="cmd-desc">Remove a saved server.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw server list</div>
      <div class="cmd-desc">List all saved server connections.</div>
    </div>
    <div class="cmd-entry">
      <div class="cmd-sig">cw mcp-server</div>
      <div class="cmd-desc">Start the MCP (Model Context Protocol) server over stdin/stdout.</div>
    </div>
  </div>
</section>

<!-- ════════════════════════ Orchestration ════════════════════════ -->
<section id="orchestration">
  <h2>LLM Orchestration</h2>
  <p>Codewire is designed for LLM-driven multi-agent workflows. Tags, subscriptions, and wait provide structured coordination primitives &mdash; no polling, no output parsing.</p>

  <h3>Tags</h3>
  <p>Label sessions at launch for filtering and coordination.</p>
  <div class="code-block"><pre><code><span class="cmd">cw launch</span> <span class="flag">--tag</span> worker <span class="flag">--tag</span> build <span class="flag">--</span> claude <span class="flag">-p</span> <span class="str">"fix tests"</span>
<span class="cmd">cw launch</span> <span class="flag">--tag</span> worker <span class="flag">--tag</span> lint <span class="flag">--</span> claude <span class="flag">-p</span> <span class="str">"fix lint issues"</span>
<span class="cmd">cw kill</span> <span class="flag">--tag</span> worker          <span class="cmt"># kill all workers</span></code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>

  <h3>Subscribe to Events</h3>
  <p>Stream structured, typed events from sessions in real-time.</p>
  <div class="code-block"><pre><code><span class="cmd">cw subscribe</span> <span class="flag">--tag</span> worker <span class="flag">--event</span> session.status
<span class="cmd">cw subscribe</span> <span class="flag">--session</span> <span class="num">3</span></code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>
  <p>Event types: <code>session.created</code>, <code>session.status</code>, <code>session.output_summary</code>, <code>session.input</code>, <code>session.attached</code>, <code>session.detached</code>, <code>direct.message</code>, <code>message.request</code>, <code>message.reply</code></p>

  <h3>Wait for Completion</h3>
  <p>Block until sessions finish &mdash; replaces polling.</p>
  <div class="code-block"><pre><code><span class="cmd">cw wait</span> <span class="num">3</span>                                         <span class="cmt"># wait for session 3</span>
<span class="cmd">cw wait</span> <span class="flag">--tag</span> worker <span class="flag">--condition</span> all              <span class="cmt"># ALL workers</span>
<span class="cmd">cw wait</span> <span class="flag">--tag</span> worker <span class="flag">--condition</span> any <span class="flag">--timeout</span> <span class="num">60</span> <span class="cmt"># ANY, 60s</span></code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>

  <h3>Agent Messaging</h3>
  <p>Named agents exchange structured messages &mdash; direct messages for fire-and-forget, request/reply for synchronous coordination.</p>
  <div class="code-block"><pre><code><span class="cmt"># Launch named agents</span>
<span class="cmd">cw launch</span> planner <span class="flag">--</span> claude <span class="flag">-p</span> <span class="str">"plan the refactor"</span>
<span class="cmd">cw launch</span> coder <span class="flag">--</span> claude <span class="flag">-p</span> <span class="str">"implement changes"</span>

<span class="cmt"># Send a direct message</span>
<span class="cmd">cw msg</span> <span class="flag">-f</span> planner coder <span class="str">"start with the auth module"</span>

<span class="cmt"># Request/reply — synchronous coordination</span>
<span class="cmd">cw request</span> <span class="flag">-f</span> planner coder <span class="str">"ready for review?"</span>
<span class="cmt"># [reply from coder] yes, PR #42 is up</span>

<span class="cmt"># Monitor all message traffic</span>
<span class="cmd">cw listen</span></code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>

  <h3>Supervisor Pattern</h3>
  <div class="code-block"><pre><code><span class="cmt"># Launch tagged workers</span>
<span class="cmd">cw launch</span> <span class="flag">--tag</span> worker <span class="flag">--</span> claude <span class="flag">-p</span> <span class="str">"implement feature X"</span>
<span class="cmd">cw launch</span> <span class="flag">--tag</span> worker <span class="flag">--</span> claude <span class="flag">-p</span> <span class="str">"write tests for X"</span>

<span class="cmt"># Wait for all to complete</span>
<span class="cmd">cw wait</span> <span class="flag">--tag</span> worker <span class="flag">--condition</span> all <span class="flag">--timeout</span> <span class="num">300</span>

<span class="cmt"># Check results</span>
<span class="cmd">cw list</span> <span class="flag">--json</span></code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>

  <h3>Multi-Agent Patterns</h3>
  <ul>
    <li><strong>Agent Messaging</strong> &mdash; Named agents exchange messages with <code>cw msg</code>, coordinate with <code>cw request</code>/<code>cw reply</code></li>
    <li><strong>Multiple Attachments</strong> &mdash; Multiple clients can attach to the same session simultaneously</li>
    <li><strong>Supervisor</strong> &mdash; One orchestrator launches and waits on tagged worker sessions</li>
    <li><strong>Agent Swarms</strong> &mdash; Parallel agents with event subscriptions for coordination</li>
    <li><strong>Cross-Session</strong> &mdash; Use <code>cw send</code> and <code>cw watch</code> to pipe data between sessions</li>
    <li><strong>Shared State</strong> &mdash; Use <code>cw kv</code> for cross-node key-value coordination (relay mode)</li>
  </ul>
</section>

<!-- ════════════════════════ Architecture ════════════════════════ -->
<section id="architecture">
  <h2>Architecture</h2>

  <h3>Node Architecture</h3>
  <p>A single Go binary acts as both node and CLI client. The node manages PTY sessions and keeps processes alive regardless of client connections.</p>

<div class="diagram" role="img" aria-label="Node architecture diagram">
                       <span class="hl">cw node</span>
                  <span class="dim">~/.codewire/codewire.sock</span>

  +----------------------------------------------+
  |              <span class="label">SessionManager</span>                   |
  |                                              |
  |   +----------+  +----------+                 |
  |   | <span class="label">Sess 1</span>   |  | <span class="label">Sess 2</span>   |   ...         |
  |   +----+-----+  +----+-----+                 |
  |        |              |                      |
  |   +----+--------------+------+               |
  |   |    Per-Session:          |               |
  |   |                          |               |
  |   |    <span class="dim">+-  PTY master  -+</span>    |               |
  |   |    <span class="dim">|   /dev/ptmx   |</span>    |               |
  |   |    <span class="dim">+---------------+</span>    |               |
  |   |                          |               |
  |   |    <span class="dim">+-  broadcast  --+</span>    |               |
  |   |    <span class="dim">|  4096 buffer  |</span>    |    output     |
  |   |    <span class="dim">+-------+-------+</span>    +-----------&gt;  | <span class="label">clients</span>
  |   |            |             |               |
  |   |    <span class="dim">+-  input chan  --+</span>    |    input      |
  |   |    <span class="dim">|   256 buffer  |</span>    |  &lt;-----------+ |
  |   |    <span class="dim">+---------------+</span>    |               |
  |   |                          |               |
  |   |    <span class="dim">output.log</span>            |               |
  |   |    <span class="dim">events.jsonl</span>          |               |
  |   +--------------------------+               |
  |                                              |
  |   <span class="dim">SubscriptionManager (event pub/sub)</span>          |
  |   <span class="dim">sessions.json (debounced 500ms)</span>              |
  +----------------------------------------------+
                       |
            +----------+----------+
            |                     |
       <span class="label">Unix Socket</span>            <span class="label">WebSocket</span>
       <span class="dim">local clients</span>           <span class="dim">:9100 (opt.)</span>
</div>

  <h3>Relay Topology</h3>
  <p>SSH gateway for remote access. Nodes establish persistent outbound WebSocket connections to a relay server &mdash; no root required, works behind NAT.</p>

<div class="diagram" role="img" aria-label="Relay topology diagram">
                          <span class="hl">INTERNET</span>
                             |
                    +--------+--------+
                    |   <span class="label">cw relay</span>      |
                    | HTTPS :443      |  <span class="dim">&lt;- Clients connect here</span>
                    | SSH  :2222      |  <span class="dim">&lt;- SSH into any node</span>
                    | /node/connect   |  <span class="dim">&lt;- Nodes connect here (WS)</span>
                    | /api/v1/kv/*    |  <span class="dim">&lt;- Shared KV store</span>
                    +--------+--------+
                        |         |
           WS agent     |         |   WS agent
           (outbound)   |         |   (outbound)
                        |         |
                +-------+--+  +---+-------+
                | <span class="label">cw node</span>  |  | <span class="label">cw node</span>   |
                | "dev-1"  |  | "gpu-box" |
                +----------+  +-----------+

  <span class="hl">Connection Flow:</span>
  1. Node registers with relay (invite or token)
  2. Node opens persistent outbound WebSocket to relay
  3. Client SSHs into relay: ssh dev-1@relay:2222
  4. Relay signals node via WebSocket, node dials back
  5. Relay bridges SSH channel to node's bash PTY
</div>

  <h3>Wire Protocol</h3>
  <p>Binary frame-based protocol used over both Unix socket and WebSocket.</p>

<div class="diagram" role="img" aria-label="Wire protocol frame format">
  <span class="hl">Frame Format</span>
  +----------+---------------+----------------------+
  | <span class="label">type</span>     | <span class="label">length</span>        | <span class="label">payload</span>              |
  | 1 byte   | 4 bytes (BE)  | up to 16 MB          |
  +----------+---------------+----------------------+

  <span class="dim">type = 0x00</span>  Control  <span class="dim">-- JSON-encoded Request/Response</span>
  <span class="dim">type = 0x01</span>  Data     <span class="dim">-- Raw bytes (PTY I/O)</span>

  <span class="hl">WebSocket Mapping</span>
  Text   frames -- Control messages (JSON)
  Binary frames -- Data messages (raw bytes)
</div>
</section>

<!-- ════════════════════════ Relay ════════════════════════ -->
<section id="relay">
  <h2>Remote Access</h2>
  <p>Two tiers: <strong>Standalone</strong> (default, zero config, local only) and <strong>Relay mode</strong> (opt-in remote access via SSH gateway).</p>

  <h3>Setup</h3>
  <div class="code-block"><pre><code><span class="cmt"># Register your node with a relay</span>
<span class="cmd">cw setup</span> <span class="flag">--relay-url</span> https://relay.codewire.sh <span class="flag">--invite</span> &lt;token&gt;

<span class="cmt"># That's it. Your node is now accessible via SSH.</span>
ssh dev-1@relay.codewire.sh -p 2222</code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>

  <h3>Remote Commands</h3>
  <p>All commands accept an optional node prefix:</p>
  <div class="code-block"><pre><code><span class="cmd">cw nodes</span>                                  <span class="cmt"># list all nodes</span>
<span class="cmd">cw list</span> dev-1                              <span class="cmt"># sessions on dev-1</span>
<span class="cmd">cw attach</span> dev-1:<span class="num">3</span>                          <span class="cmt"># session 3 on dev-1</span>
<span class="cmd">cw launch</span> dev-1 <span class="flag">--tag</span> worker <span class="flag">--</span> claude <span class="flag">-p</span> <span class="str">"fix bug"</span>
<span class="cmd">cw kill</span> dev-1:<span class="num">3</span></code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>

  <h3>Direct WebSocket</h3>
  <p>You can also connect directly via WebSocket without a relay:</p>
  <div class="code-block"><pre><code><span class="cmd">cw server add</span> my-server wss://remote-host:9100 <span class="flag">--token</span> &lt;token&gt;
<span class="cmd">cw</span> <span class="flag">--server</span> my-server list</code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>
</section>

<!-- ════════════════════════ Configuration ════════════════════════ -->
<section id="configuration">
  <h2>Configuration</h2>

  <h3>Config File</h3>
  <p>Located at <code>~/.codewire/config.toml</code></p>
  <div class="code-block"><pre><code><span class="kw">[node]</span>
<span class="flag">name</span> = <span class="str">"my-node"</span>                          <span class="cmt"># Node name</span>
<span class="flag">listen</span> = <span class="str">"0.0.0.0:9100"</span>                   <span class="cmt"># Direct WebSocket (optional)</span>
<span class="flag">external_url</span> = <span class="str">"wss://host/ws"</span>            <span class="cmt"># Advertised URL</span>
<span class="flag">relay_url</span> = <span class="str">"https://relay.codewire.sh"</span>  <span class="cmt"># Opt-in remote access</span></code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>

  <h3>Environment Variable Overrides</h3>
  <table>
    <thead><tr><th>Variable</th><th>Overrides</th></tr></thead>
    <tbody>
      <tr><td><code>CODEWIRE_NODE_NAME</code></td><td>node.name</td></tr>
      <tr><td><code>CODEWIRE_LISTEN</code></td><td>node.listen</td></tr>
      <tr><td><code>CODEWIRE_EXTERNAL_URL</code></td><td>node.external_url</td></tr>
      <tr><td><code>CODEWIRE_RELAY_URL</code></td><td>node.relay_url</td></tr>
      <tr><td><code>CODEWIRE_TOKEN</code></td><td>Auth token (for containers)</td></tr>
    </tbody>
  </table>

  <h3>Data Directory</h3>
  <p><code>~/.codewire/</code> contains all runtime state.</p>
<div class="diagram" role="img" aria-label="Data directory layout">
~/.codewire/
|-- codewire.sock         <span class="dim"># Unix domain socket</span>
|-- codewire.pid          <span class="dim"># Node PID file</span>
|-- token                 <span class="dim"># Auth token (direct WS fallback)</span>
|-- config.toml           <span class="dim"># Configuration</span>
|-- servers.toml          <span class="dim"># Saved remote servers</span>
|-- sessions.json         <span class="dim"># Session metadata</span>
`-- sessions/
    |-- 1/
    |   |-- output.log    <span class="dim"># Captured PTY output</span>
    |   `-- events.jsonl  <span class="dim"># Metadata event log</span>
    `-- 2/
        |-- output.log
        `-- events.jsonl
</div>
</section>

<!-- ════════════════════════ MCP ════════════════════════ -->
<section id="mcp">
  <h2>MCP Integration</h2>
  <p>Codewire exposes an MCP server (JSON-RPC 2.0 over stdin/stdout) so AI agents can programmatically manage sessions.</p>

  <h3>Claude Code Config</h3>
  <div class="code-block"><pre><code><span class="cmt"># Add as MCP server (user-level)</span>
<span class="cmd">claude mcp add</span> <span class="flag">--scope</span> user codewire <span class="flag">--</span> cw mcp-server</code></pre><button class="copy-btn" onclick="copyText('claude mcp add --scope user codewire -- cw mcp-server',this)">copy</button></div>

  <h3>Available Tools</h3>
  <table>
    <thead><tr><th>Tool</th><th>Description</th><th>Key Parameters</th></tr></thead>
    <tbody>
      <tr>
        <td><code>codewire_launch_session</code></td>
        <td>Launch a new session</td>
        <td><code>command</code>, <code>working_dir</code>, <code>tags</code></td>
      </tr>
      <tr>
        <td><code>codewire_list_sessions</code></td>
        <td>List all sessions</td>
        <td><code>status_filter</code>: all | running | completed</td>
      </tr>
      <tr>
        <td><code>codewire_read_session_output</code></td>
        <td>Read output snapshot</td>
        <td><code>session_id</code>, <code>tail</code>, <code>max_chars</code></td>
      </tr>
      <tr>
        <td><code>codewire_send_input</code></td>
        <td>Send input to session</td>
        <td><code>session_id</code>, <code>input</code>, <code>auto_newline</code></td>
      </tr>
      <tr>
        <td><code>codewire_watch_session</code></td>
        <td>Monitor (time-bounded)</td>
        <td><code>session_id</code>, <code>max_duration_seconds</code></td>
      </tr>
      <tr>
        <td><code>codewire_get_session_status</code></td>
        <td>Detailed session info</td>
        <td><code>session_id</code></td>
      </tr>
      <tr>
        <td><code>codewire_kill_session</code></td>
        <td>Terminate session</td>
        <td><code>session_id</code>, <code>tags</code></td>
      </tr>
      <tr>
        <td><code>codewire_subscribe</code></td>
        <td>Subscribe to events</td>
        <td><code>tags</code>, <code>event_types</code>, <code>duration_seconds</code></td>
      </tr>
      <tr>
        <td><code>codewire_wait_for</code></td>
        <td>Wait for completion</td>
        <td><code>session_id</code>, <code>tags</code>, <code>condition</code>, <code>timeout</code></td>
      </tr>
      <tr>
        <td><code>codewire_msg</code></td>
        <td>Send a direct message</td>
        <td><code>to_session_id</code> | <code>to_name</code>, <code>body</code>, <code>from_session_id</code></td>
      </tr>
      <tr>
        <td><code>codewire_read_messages</code></td>
        <td>Read session inbox</td>
        <td><code>session_id</code>, <code>tail</code></td>
      </tr>
      <tr>
        <td><code>codewire_request</code></td>
        <td>Request and block for reply</td>
        <td><code>to_session_id</code> | <code>to_name</code>, <code>body</code>, <code>timeout_seconds</code></td>
      </tr>
      <tr>
        <td><code>codewire_reply</code></td>
        <td>Reply to a pending request</td>
        <td><code>request_id</code>, <code>body</code>, <code>from_session_id</code></td>
      </tr>
      <tr>
        <td><code>codewire_list_nodes</code></td>
        <td>List relay nodes</td>
        <td>&mdash;</td>
      </tr>
      <tr>
        <td><code>codewire_kv_set</code></td>
        <td>Set key-value</td>
        <td><code>namespace</code>, <code>key</code>, <code>value</code>, <code>ttl</code></td>
      </tr>
      <tr>
        <td><code>codewire_kv_get</code></td>
        <td>Get value by key</td>
        <td><code>namespace</code>, <code>key</code></td>
      </tr>
      <tr>
        <td><code>codewire_kv_list</code></td>
        <td>List keys by prefix</td>
        <td><code>namespace</code>, <code>prefix</code></td>
      </tr>
      <tr>
        <td><code>codewire_kv_delete</code></td>
        <td>Delete key</td>
        <td><code>namespace</code>, <code>key</code></td>
      </tr>
    </tbody>
  </table>
</section>

<!-- ════════════════════════ Installation ════════════════════════ -->
<section id="installation">
  <h2>Installation</h2>

  <h3>Homebrew</h3>
  <div class="badges">
    <span class="badge">macOS aarch64</span>
    <span class="badge">macOS x86_64</span>
    <span class="badge">Linux aarch64</span>
    <span class="badge">Linux x86_64</span>
  </div>
  <div class="code-block"><pre><code><span class="cmd">brew install</span> codewiresh/codewire/codewire</code></pre><button class="copy-btn" onclick="copyText('brew install codewiresh/codewire/codewire',this)">copy</button></div>

  <h3>Install Script</h3>
  <p>Downloads the binary, verifies GPG signature and SHA256 checksum.</p>
  <div class="code-block"><pre><code><span class="cmd">curl</span> <span class="flag">-fsSL</span> https://raw.githubusercontent.com/codewiresh/codewire/main/install.sh <span class="flag">|</span> bash</code></pre><button class="copy-btn" onclick="copyText('curl -fsSL https://raw.githubusercontent.com/codewiresh/codewire/main/install.sh | bash',this)">copy</button></div>
  <p>Options: <code>--version VERSION</code>, <code>--prefix DIR</code>, <code>--verbose</code></p>

  <h3>Build from Source</h3>
  <div class="code-block"><pre><code><span class="cmd">go build</span> <span class="flag">-o</span> cw ./cmd/cw
<span class="cmd">sudo mv</span> cw /usr/local/bin/cw</code></pre><button class="copy-btn" onclick="copyText('go build -o cw ./cmd/cw && sudo mv cw /usr/local/bin/cw',this)">copy</button></div>

  <h3>Coder Module</h3>
  <p>Add Codewire to Coder workspaces with a Terraform module:</p>
  <div class="code-block"><pre><code><span class="kw">module</span> <span class="str">"codewire"</span> {
  <span class="flag">source</span>   = <span class="str">"github.com/codewiresh/codewire//coder-module"</span>
  <span class="flag">agent_id</span> = coder_agent.main.id
  <span class="flag">folder</span>   = <span class="str">"/home/coder/project"</span>
}</code></pre><button class="copy-btn" onclick="copySnippet(this)">copy</button></div>

  <table>
    <thead><tr><th>Variable</th><th>Default</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td><code>agent_id</code></td><td><em>required</em></td><td>The ID of a Coder agent</td></tr>
      <tr><td><code>folder</code></td><td><code>/home/coder</code></td><td>Working directory for sessions</td></tr>
      <tr><td><code>install_codewire</code></td><td><code>true</code></td><td>Whether to install cw</td></tr>
      <tr><td><code>codewire_version</code></td><td><code>latest</code></td><td>Version to install</td></tr>
      <tr><td><code>experiment_report_tasks</code></td><td><code>false</code></td><td>Enable Coder MCP task reporting</td></tr>
    </tbody>
  </table>
</section>

</main>

<!-- ════════════════════════ Footer ════════════════════════ -->
<footer style="text-align:center;padding:24px;border-top:1px solid var(--border);color:var(--fg-dim);font-size:12px;font-family:var(--font-mono)">
  <a href="https://github.com/codewiresh/codewire" style="color:var(--fg-dim)">github.com/codewiresh/codewire</a>
  &nbsp;&middot;&nbsp; MIT License
</footer>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/css/xterm.min.css">
<script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0/lib/addon-fit.min.js"></script>

<script>
// ── Theme Toggle ──
function getPreferredTheme() {
  const saved = localStorage.getItem('cw-theme');
  if (saved) return saved;
  return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  document.getElementById('theme-icon').textContent = theme === 'light' ? '\u2600' : '\u263E';
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = current === 'dark' ? 'light' : 'dark';
  localStorage.setItem('cw-theme', next);
  applyTheme(next);
}

applyTheme(getPreferredTheme());

window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
  if (!localStorage.getItem('cw-theme')) {
    applyTheme(e.matches ? 'light' : 'dark');
  }
});

// ── Copy Buttons ──
function copyText(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'copied';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'copy';
      btn.classList.remove('copied');
    }, 1500);
  });
}

function copySnippet(btn) {
  const pre = btn.closest('.code-block').querySelector('pre');
  const text = pre.textContent;
  copyText(text, btn);
}

// ── Terminal Demo ──
(function() {
  const MAX_LINES = 16;
  const el = document.getElementById('term-demo');
  if (!el) return;

  const linesEl = el.querySelector('.term-lines');
  const typedEl = el.querySelector('.term-typed');
  const cursorEl = el.querySelector('.term-cursor');
  const inputLine = el.querySelector('.term-input-line');

  let running = true;
  let paused = false;

  // Pause when offscreen.
  const obs = new IntersectionObserver(([e]) => { paused = !e.isIntersecting; }, { threshold: 0.1 });
  obs.observe(el);

  function sleep(ms) {
    return new Promise(r => {
      const check = () => { if (paused) { setTimeout(check, 100); } else { setTimeout(r, ms); } };
      check();
    });
  }

  function addLine(html) {
    const div = document.createElement('div');
    div.className = 'term-line';
    div.innerHTML = html;
    linesEl.appendChild(div);
    // Evict old lines.
    while (linesEl.children.length > MAX_LINES) linesEl.removeChild(linesEl.firstChild);
  }

  async function typeCmd(text) {
    inputLine.style.display = 'flex';
    typedEl.textContent = '';
    cursorEl.style.display = '';
    for (const ch of text) {
      typedEl.textContent += ch;
      await sleep(35 + Math.random() * 25);
    }
    await sleep(300);
    // Move typed command to lines area.
    addLine('<span class="prompt-mark">$ </span>' + escHtml(text));
    typedEl.textContent = '';
  }

  function output(text, cls) {
    addLine('<span class="' + (cls || 'output') + '">' + escHtml(text) + '</span>');
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  const script = [
    { type:'cmd', text:'cw launch planner -- claude -p "plan the refactor"' },
    { type:'out', text:'Session 1 launched: claude -p "plan the refactor"' },
    { type:'pause', ms:400 },
    { type:'cmd', text:'cw launch coder -- claude -p "implement changes"' },
    { type:'out', text:'Session 2 launched: claude -p "implement changes"' },
    { type:'pause', ms:500 },
    { type:'cmd', text:'cw list' },
    { type:'raw', html:'<span class="table-header">ID   NAME           COMMAND                          STATUS     AGE</span>' },
    { type:'raw', html:'<span class="table-row">1    planner        claude -p "plan the refactor"    running    2m ago</span>' },
    { type:'raw', html:'<span class="table-row">2    coder          claude -p "implement changes"    running    30s ago</span>' },
    { type:'pause', ms:600 },
    { type:'cmd', text:'cw msg -f planner coder "start with the auth module"' },
    { type:'out', text:'Message sent: msg_a1b2c3d4' },
    { type:'pause', ms:500 },
    { type:'cmd', text:'cw request -f planner coder "ready for review?"' },
    { type:'pause', ms:1200 },
    { type:'raw', html:'<span class="accent">[reply from coder] yes, PR #42 is up</span>' },
    { type:'pause', ms:600 },
    { type:'cmd', text:'cw listen' },
    { type:'pause', ms:400 },
    { type:'stream', html:'<span class="accent">[planner \u2192 coder] implement the login endpoint</span>', delay:600 },
    { type:'stream', html:'<span class="accent">[coder \u2192 planner] REQUEST (req_x7y8): need DB schema?</span>', delay:800 },
    { type:'stream', html:'<span class="accent">[planner] REPLY (req_x7y8): use the existing users table</span>', delay:700 },
    { type:'pause', ms:1500 },
    { type:'clear' },
  ];

  async function run() {
    while (running) {
      for (const step of script) {
        if (!running) return;
        switch (step.type) {
          case 'cmd':
            await typeCmd(step.text);
            break;
          case 'out':
            output(step.text);
            await sleep(100);
            break;
          case 'raw':
            addLine(step.html);
            await sleep(60);
            break;
          case 'stream':
            await sleep(step.delay || 500);
            addLine(step.html);
            break;
          case 'pause':
            await sleep(step.ms);
            break;
          case 'clear':
            cursorEl.style.display = 'none';
            inputLine.style.display = 'none';
            el.classList.add('fade-out');
            await sleep(800);
            linesEl.innerHTML = '';
            typedEl.textContent = '';
            el.classList.remove('fade-out');
            inputLine.style.display = 'flex';
            cursorEl.style.display = '';
            await sleep(600);
            break;
        }
      }
    }
  }

  run();
})();

// ── Live Demo (inline xterm.js widget) ──
window.cwDemo = (function() {
  const BROKER_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    ? 'http://localhost:8080'
    : 'https://demo.codewire.sh';

  let liveTerm = null;
  let liveWS = null;
  let liveFit = null;

  async function tryLive() {
    const btn = document.getElementById('try-live-btn');
    const animated = document.getElementById('term-animated');
    const container = document.getElementById('live-term-container');
    const toolbar = document.getElementById('live-toolbar');
    const title = document.getElementById('term-title');

    btn.disabled = true;
    btn.textContent = 'Connecting...';

    try {
      const resp = await fetch(BROKER_URL + '/api/session');
      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        throw new Error(data.error || 'Server returned ' + resp.status);
      }
      const sessionData = await resp.json();

      // Switch from animated to live terminal
      animated.classList.add('hidden');
      container.classList.remove('hidden');
      toolbar.classList.remove('hidden');
      btn.classList.add('hidden');
      title.textContent = 'live demo — read only';

      // Init xterm
      liveTerm = new Terminal({
        cursorBlink: false,
        fontSize: 13,
        fontFamily: 'ui-monospace, "SF Mono", "Cascadia Code", Menlo, Consolas, monospace',
        theme: {
          background: '#1a1a1a',
          foreground: '#c8c8c8',
          cursor: '#7eb8da',
          selectionBackground: 'rgba(126,184,218,0.3)',
        },
        rows: 14,
        disableStdin: true,
        allowProposedApi: true,
      });
      liveFit = new FitAddon.FitAddon();
      liveTerm.loadAddon(liveFit);
      liveTerm.open(container);
      liveFit.fit();

      // Update expand link
      const expandLink = document.getElementById('live-expand');
      expandLink.href = '/demo?ws=' + encodeURIComponent(sessionData.ws);

      connectLiveWS(sessionData.ws);
    } catch (err) {
      btn.disabled = false;
      btn.innerHTML = '<span class="pulse"></span> Try it live';
      console.error('Demo error:', err);
    }
  }

  function connectLiveWS(url) {
    liveWS = new WebSocket(url);
    liveWS.binaryType = 'arraybuffer';

    liveWS.onopen = () => {
      const statusEl = document.getElementById('live-status');
      statusEl.textContent = 'Watching live demo';
      statusEl.className = 'live-timer';

      const dims = liveFit.proposeDimensions();
      if (dims) {
        const resizeMsg = new Uint8Array([2, ...new TextEncoder().encode(JSON.stringify({columns: dims.cols, rows: dims.rows}))]);
        liveWS.send(resizeMsg);
      }
    };

    liveWS.onmessage = (evt) => {
      if (evt.data instanceof ArrayBuffer) {
        const data = new Uint8Array(evt.data);
        if (data[0] === 0) {
          liveTerm.write(data.slice(1));
        }
      } else {
        try {
          const msg = JSON.parse(evt.data);
          if (msg.AuthToken) {
            liveWS.send(JSON.stringify({AuthToken: msg.AuthToken}));
          }
        } catch {
          liveTerm.write(evt.data);
        }
      }
    };

    liveWS.onclose = () => {
      const statusEl = document.getElementById('live-status');
      statusEl.textContent = 'Demo complete';
      statusEl.className = 'live-timer';
    };

    window.addEventListener('resize', () => {
      if (liveFit) liveFit.fit();
    });
  }

  function closeLive() {
    if (liveWS) { liveWS.close(); liveWS = null; }
    if (liveTerm) { liveTerm.dispose(); liveTerm = null; }

    const animated = document.getElementById('term-animated');
    const container = document.getElementById('live-term-container');
    const toolbar = document.getElementById('live-toolbar');
    const btn = document.getElementById('try-live-btn');
    const title = document.getElementById('term-title');

    animated.classList.remove('hidden');
    container.classList.add('hidden');
    toolbar.classList.add('hidden');
    container.innerHTML = '';
    btn.classList.remove('hidden');
    btn.disabled = false;
    btn.innerHTML = '<span class="pulse"></span> Try it live';
    title.textContent = 'codewire demo';
  }

  return { tryLive, closeLive };
})();
</script>
</body>
</html>
